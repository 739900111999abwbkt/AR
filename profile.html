<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>الملف الشخصي - AirChat</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to your global styles -->
    <link rel="stylesheet" href="style.css" />
    <style>
        /* Specific styles for the profile container, complementing style.css */
        .profile-container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 500px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .profile-container h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 1.5rem;
        }
        .profile-info {
            background-color: #f9fafb;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            color: #333;
        }
        .profile-info p {
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .profile-info strong {
            color: #4f46e5;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .profile-info span {
            flex-grow: 1;
            text-align: left;
            word-break: break-all; /* Ensure long IDs/text wrap */
        }
        .avatar-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .avatar-upload-area label {
            cursor: pointer;
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease;
        }
        .avatar-upload-area label:hover {
            background-color: #4338ca;
        }
        .avatar-upload-area input[type="file"] {
            display: none;
        }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen bg-gray-100 dark:bg-gray-900">
    <div class="profile-container">
        <h2>ملفي الشخصي</h2>
        <div class="avatar-upload-area">
            <img id="user-avatar" src="https://placehold.co/120x120/cccccc/333333?text=User" alt="User Avatar" class="avatar"/>
            <label for="avatar-input">تغيير الصورة الشخصية</label>
            <input type="file" id="avatar-input" accept="image/*" />
        </div>
        <div class="profile-info">
            <p><strong>الاسم:</strong> <span id="username">...</span></p>
            <p><strong>ID:</strong> <span id="user-id">...</span></p>
            <p><strong>البريد الإلكتروني:</strong> <span id="user-email">...</span></p>
            <p><strong>الدور:</strong> <span id="user-role">...</span></p>
            <p><strong>النبذة:</strong> <span id="bio">...</span></p>
            <p><strong>الاهتمامات:</strong> <span id="interests">...</span></p>
            <p><strong>نقاط الخبرة (XP):</strong> <span id="user-xp">...</span></p>
            <p><strong>المستوى:</strong> <span id="user-level">...</span></p>
            <p><strong>الهدايا المستلمة:</strong> <span id="user-gifts">...</span></p>
            <p><strong>مستوى VIP:</strong> <span id="user-vip-level">...</span></p>
        </div>
        <button onclick="goBack()" class="button">رجوع</button>
    </div>

    <script type="module">
        import { showCustomAlert } from './js/utils.js'; // Import custom alert utility

        // Function to load user data from localStorage
        function loadUserData() {
            document.getElementById('username').textContent = localStorage.getItem('username') || 'مجهول';
            document.getElementById('user-id').textContent = localStorage.getItem('userId') || 'غير معروف';
            document.getElementById('user-email').textContent = localStorage.getItem('userEmail') || 'غير متاح';
            document.getElementById('user-role').textContent = localStorage.getItem('userRole') || 'مستخدم';
            document.getElementById('bio').textContent = localStorage.getItem('userBio') || 'لا توجد نبذة';
            document.getElementById('interests').textContent = JSON.parse(localStorage.getItem('userInterests') || '[]').join(', ') || 'غير محدد';
            document.getElementById('user-xp').textContent = localStorage.getItem('userXP') || '0';
            document.getElementById('user-gifts').textContent = localStorage.getItem('userGiftsReceived') || '0';
            document.getElementById('user-vip-level').textContent = localStorage.getItem('userVipLevel') || '0';

            const userAvatar = localStorage.getItem('userAvatar');
            if (userAvatar) {
                document.getElementById('user-avatar').src = userAvatar;
            }

            // Calculate and display level based on XP
            const xp = parseInt(localStorage.getItem('userXP') || '0');
            document.getElementById('user-level').textContent = calculateLevel(xp);
        }

        // Dummy function to calculate level (should match backend logic)
        function calculateLevel(xp) {
            if (xp >= 500) return 5;
            if (xp >= 300) return 4;
            if (xp >= 200) return 3;
            if (xp >= 100) return 2;
            return 1;
        }

        // Function to handle avatar upload
        document.getElementById('avatar-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const newAvatarUrl = e.target.result;
                    document.getElementById('user-avatar').src = newAvatarUrl;
                    localStorage.setItem('userAvatar', newAvatarUrl); // Save to local storage

                    // In a real app, you would upload this to a server (e.g., Firebase Storage)
                    // and then update the user's profile in Firestore with the new URL.
                    const userId = localStorage.getItem('userId');
                    if (userId) {
                        // Example API call (replace with actual upload logic)
                        fetch(`/api/users/${userId}/profile`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({ avatar: newAvatarUrl }) // Send base64 or a link after upload
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                showCustomAlert('تم تحديث الصورة الشخصية بنجاح!', 'success');
                            } else {
                                showCustomAlert('فشل تحديث الصورة الشخصية.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error uploading avatar:', error);
                            showCustomAlert('حدث خطأ أثناء تحديث الصورة الشخصية.', 'error');
                        });
                    }
                };
                reader.readAsDataURL(file); // Read file as Data URL (base64)
            }
        });

        // Load user data when the page loads
        window.onload = loadUserData;

        // Function to go back to the previous page
        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html>
