<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿµŸàÿ™Ÿäÿ© - AirChat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Link to global styles (custom styles will be here eventually) -->
    <link rel="stylesheet" href="style.css">
    <!-- Socket.IO client -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Base styles for the entire page */
        body {
            background-color: #8B0000; /* Deep Red for a bold, attractive look */
            background-image: url('assets/images/room-bg-fire.jpg'); /* Dynamic background: fire, smoke, or elegant theme */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Keep background fixed when scrolling */
            transition: background-image 0.5s ease, background-color 0.5s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll, let specific divs scroll */
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Right-to-left for Arabic */
            color: #e0e0e0; /* Light text color for dark background */
        }

        /* Main room container */
        #room-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Push top/bottom elements apart */
            padding: 0; /* No padding on main container, handled by sub-elements */
            position: relative;
            width: 100%;
            min-height: 100vh;
        }

        /* Top Bar - User Info & Global Controls */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Darker, more opaque */
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 200; /* Highest z-index */
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4);
            color: white;
            font-size: 0.95rem;
            backdrop-filter: blur(5px); /* Frosted glass effect */
        }
        #top-bar .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        #top-bar .user-info img {
            width: 45px; /* Slightly larger avatar */
            height: 45px;
            border-radius: 50%;
            border: 3px solid #FFD700; /* Gold border for premium feel */
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }
        #top-bar .user-id {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        #top-bar .global-controls {
            display: flex;
            gap: 15px;
        }
        #top-bar .global-controls button {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 8px 15px;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #top-bar .global-controls button:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        /* Stage Mics Grid - Main central area for featured speakers */
        #stage-mics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Larger and more flexible */
            gap: 2.5rem; /* Good spacing */
            padding: 20px;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1000px; /* Wider stage area */
            margin-top: 80px; /* Space for top bar */
            margin-bottom: 20px; /* Space before central message/chat */
            z-index: 50;
            flex-shrink: 0;
            flex-grow: 1; /* Allow it to take vertical space */
            align-content: center; /* Center content vertically */
            overflow-y: auto; /* Allow scrolling if many mics */
            -webkit-overflow-scrolling: touch;
        }

        /* Individual Stage Mic Slot */
        .stage-mic-slot {
            width: 140px; /* Even larger fixed size for stage mics */
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle at 70% 30%, #4a0000, #2a0000); /* Darker red gradient for empty slot */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
            position: relative;
            color: #ccc;
            font-weight: bold;
            font-size: 1.3rem;
            border: 3px dashed rgba(255, 255, 255, 0.3); /* Lighter dashed border for empty */
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden; /* Hide overflow for content */
        }
        .stage-mic-slot.occupied {
            background: radial-gradient(circle at 70% 30%, #FF4500, #B22222); /* Vibrant red gradient when occupied */
            box-shadow: 0 0 25px rgba(255, 69, 0, 0.8);
            border: 4px solid #FFD700; /* Gold border when occupied */
        }
        .stage-mic-slot.active { /* Speaking indicator */
            box-shadow: 0 0 0 8px #00FF7F, 0 0 30px #00FF7F; /* Bright green glow */
            animation: pulse-mic 1s infinite;
            border-color: #00FF7F; /* Green border when active */
        }
        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 8px #00FF7F; }
            50% { box-shadow: 0 0 0 16px #00FF7F; }
            100% { box-shadow: 0 0 0 8px #00FF7F; }
        }
        .stage-mic-slot img {
            width: 90px; /* Larger avatar */
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white; /* Thicker white border */
            margin-bottom: 8px; /* More space for name */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .stage-mic-slot .mic-name {
            font-weight: 700;
            font-size: 1.1rem; /* Larger font size */
            text-shadow: 1px 1px 4px rgba(0,0,0,0.8);
            color: white;
        }
        .stage-mic-slot .mic-number {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .stage-mic-slot .user-status {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 20px; /* Larger status indicator */
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            z-index: 5;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .online { background-color: #00FF7F; } /* Bright green for online */
        .offline { background-color: #FF6347; } /* Tomato for offline */
        .stage-mic-slot.muted {
            filter: grayscale(80%);
            opacity: 0.7;
            border-color: #FF6347; /* Tomato border for muted */
            box-shadow: 0 0 15px rgba(255, 99, 71, 0.6);
        }
        .stage-mic-slot.admin::after {
            content: "üëë";
            position: absolute;
            top: -12px;
            right: -12px;
            font-size: 28px; /* Larger crown */
            z-index: 10;
            text-shadow: 0 0 5px gold;
        }
        .stage-mic-slot.vip {
            border: 5px solid #FFD700 !important; /* Even thicker gold border */
            box-shadow: 0 0 20px #FFD700 !important;
        }
        /* Hide badges/scores on stage mics by default */
        .stage-mic-slot .level-badge, .stage-mic-slot .gift-badge, .stage-mic-slot .react-score {
            display: none;
        }

        /* Request Mic Button */
        #request-mic-btn {
            background: linear-gradient(45deg, #FF4500, #FF8C00); /* Orange-red gradient */
            color: white;
            font-size: 1.2rem;
            padding: 15px 30px;
            border-radius: 2rem; /* More rounded, pill-shaped */
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(255, 69, 0, 0.5);
            transition: all 0.3s ease;
            margin-top: 20px;
            margin-bottom: 20px;
            border: none;
            cursor: pointer;
        }
        #request-mic-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 69, 0, 0.7);
        }

        /* General Mics Grid - For other users in the room (smaller) */
        #general-mics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); /* Slightly larger small mics */
            gap: 1.2rem;
            padding: 15px;
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            margin-bottom: 80px; /* Space for bottom bar */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 40;
            background-color: rgba(0, 0, 0, 0.5); /* More opaque background */
            border-radius: 1.5rem;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7);
            min-height: 100px; /* Ensure it has some height even if empty */
            flex-shrink: 0;
        }
        .general-mic-circle {
            width: 80px; /* Small size */
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(#00e5ff, #007acc); /* Blue gradient */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            color: white;
            font-size: 0.7rem;
            border: 2px solid transparent; /* For active state */
        }
        .general-mic-circle img {
            width: 55px; /* Larger avatar */
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            margin-bottom: 4px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .general-mic-circle .mic-name {
            font-weight: 600;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
        }
        .general-mic-circle.active {
            box-shadow: 0 0 0 4px #00FF7F, 0 0 20px #00FF7F;
            animation: pulse-mic-small 1s infinite;
            border-color: #00FF7F;
        }
        @keyframes pulse-mic-small {
            0% { box-shadow: 0 0 0 4px #00FF7F; }
            50% { box-shadow: 0 0 0 8px #00FF7F; }
            100% { box-shadow: 0 0 0 4px #00FF7F; }
        }
        /* Inherit other mic-circle styles like muted, admin, vip, user-status, badges */
        .general-mic-circle .user-status {
            bottom: 4px; /* Adjusted for smaller size */
            right: 4px;
            width: 16px;
            height: 16px;
        }
        .general-mic-circle .level-badge, .general-mic-circle .gift-badge {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 0.4rem;
        }
        .general-mic-circle .react-score {
            font-size: 0.8rem;
            padding: 3px 6px;
            border-radius: 1rem;
        }

        /* Central Announcement/Message Area */
        #central-message-area {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px 35px;
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 70%;
            width: fit-content;
            margin: 20px auto;
            z-index: 100;
            color: #333;
            display: none; /* Hidden by default, shown by JS */
            backdrop-filter: blur(8px);
        }
        #central-message-area h3 {
            color: #8B0000; /* Deep Red heading */
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        #central-message-area p {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        /* Bottom Control Bar */
        #bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 0; /* No horizontal padding, handled by inner elements */
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 200;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
        }
        #bottom-controls .control-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-size: 0.7rem; /* Smaller font for text */
            font-weight: 600;
            gap: 4px;
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            flex: 1; /* Distribute space evenly */
            padding: 5px 0; /* Add vertical padding */
        }
        #bottom-controls .control-button:hover {
            transform: translateY(-4px); /* More pronounced lift */
            color: #00FF7F; /* Bright green on hover */
        }
        #bottom-controls .control-button svg {
            width: 30px; /* Larger icons */
            height: 30px;
            fill: currentColor;
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.5));
        }

        /* Chat Box - Positioned to the side/bottom-right */
        #chat-box-container {
            position: fixed;
            bottom: 80px; /* Above bottom controls */
            right: 20px; /* Positioned to the right */
            width: 380px; /* Wider chat box */
            max-height: 450px; /* Taller chat box */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: rgba(255, 255, 255, 0.98); /* Almost opaque white */
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            z-index: 95;
            display: none; /* Hidden by default, toggled by JS */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        #chat-box-container.show {
            display: flex;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            color: #333;
            text-shadow: none;
        }
        #chat-input-area {
            display: flex;
            gap: 0.75rem;
            width: 100%;
        }
        #chat-input-area input {
            flex-grow: 1;
            padding: 0.8rem 1.2rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db;
            background-color: #f0f0f0;
            color: #333;
        }
        #chat-input-area button {
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Gift Panel */
        #gift-panel-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 380px;
            max-height: 450px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            z-index: 100;
            display: none;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        #gift-panel-container.show {
            display: flex;
        }
        #gift-categories {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        #gift-categories button {
            background-color: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 1rem;
            white-space: nowrap;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #gift-categories button.active, #gift-categories button:hover {
            background-color: #FF4500; /* Orange-red for active/hover */
        }
        #gift-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .gift-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255,255,255,0.05);
            border-radius: 1rem;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .gift-item:hover {
            transform: translateY(-3px);
            border-color: #FFD700;
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }
        .gift-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        .gift-item .name {
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }
        .gift-item .price {
            font-size: 0.7rem;
            color: #FFD700;
            font-weight: bold;
            margin-top: 3px;
        }
        .gift-send-button {
            background-color: #00FF7F; /* Bright green send button */
            color: black;
            padding: 8px 15px;
            border-radius: 0.75rem;
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
            transition: background-color 0.2s ease;
        }
        .gift-send-button:hover {
            background-color: #00E676;
        }


        /* Floating Panels Container (holds all side panels) */
        #floating-panels-container {
            position: fixed;
            top: 80px; /* Below top bar */
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7); /* Darker, more opaque */
            padding: 20px;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 150;
            color: #eee;
            transition: all 0.3s ease;
            display: none; /* Hidden by default, toggled by JS */
            flex-direction: column;
            gap: 18px; /* More space between panels */
            max-height: calc(100vh - 180px); /* Adjust max height */
            overflow-y: auto;
            backdrop-filter: blur(8px);
        }
        #floating-panels-container.show {
            display: flex;
        }
        .floating-panel-item { /* Individual panels within the container */
            background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent white */
            padding: 15px;
            border-radius: 1rem;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .floating-panel-item h3 {
            color: #FFD700; /* Gold heading */
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .floating-panel-item ul, .floating-panel-item ol {
            color: #ccc;
        }
        .floating-panel-item .button {
            width: 100%; /* Full width buttons in panels */
            padding: 10px 0;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 0.75rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .floating-panel-item .grid {
            gap: 10px; /* Smaller gap for buttons grid */
        }
        body.dark-mode #floating-panels-container {
            background-color: rgba(0, 0, 0, 0.8);
            color: #eee;
        }
        body.dark-mode .floating-panel-item {
            background-color: rgba(255, 255, 255, 0.05);
            color: #eee;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.05);
        }

        /* User Info Popup (when clicking on a mic) */
        #user-info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95); /* Very dark, almost opaque */
            padding: 35px;
            border-radius: 2rem; /* More rounded */
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            z-index: 250; /* Above everything else */
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            color: #eee;
            max-width: 90%;
            text-align: center;
            border: 2px solid #FFD700; /* Gold border */
            backdrop-filter: blur(15px); /* Stronger blur */
        }
        #user-info-popup.show {
            display: flex;
        }
        #user-info-popup h3 {
            color: #FFD700; /* Gold heading */
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        #user-info-popup img {
            width: 100px; /* Larger avatar */
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #00FF7F; /* Bright green border */
            box-shadow: 0 0 15px rgba(0, 255, 127, 0.7);
            margin-bottom: 20px;
        }
        #user-info-popup p {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #ccc;
        }
        #user-info-popup strong {
            color: white;
        }
        #user-info-popup .button {
            margin-top: 15px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        #user-info-popup .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        #popup-moderation-buttons {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 columns for buttons */
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }


        /* Other popups/toasts */
        .popup { /* General popup styling */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 300;
            color: white;
            text-align: center;
            display: none;
            backdrop-filter: blur(8px);
        }
        .popup.show {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #pinnedMessage { 
            position: fixed;
            top: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: none; 
            background-color: rgba(255, 255, 255, 0.95);
            color: #8B0000; /* Deep Red text */
            border: 2px solid #FFD700; /* Gold border */
            font-weight: bold; 
            padding: 12px 25px;
            max-width: 80%;
            text-align: center;
            z-index: 210;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        #achievements-box { 
            position: fixed;
            bottom: 150px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: none; 
            background-color: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            padding: 15px 25px;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 200;
            font-weight: bold;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        #welcomeBanner { top: 40px; opacity: 0; transition: opacity 1s; }
        #welcome-popup { display: none; } /* Handled by .popup styles */
        #toast { 
            position: fixed;
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 25px;
            border-radius: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 500; /* Highest for toasts */
            display: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #toast.show { display: block; }
        #toast.success { background-color: rgba(0, 128, 0, 0.8); }
        #toast.error { background-color: rgba(255, 0, 0, 0.8); }
        #toast.info { background-color: rgba(0, 100, 200, 0.8); }
        #toast.warning { background-color: rgba(255, 165, 0, 0.8); }


        /* Responsive adjustments for mobile are now in style.css */

        /* Tic-Tac-Toe Game Styles */
        #tic-tac-toe-board .cell {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #tic-tac-toe-board .cell:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #tic-tac-toe-board .cell.X {
            color: #34D399; /* Green for X */
        }
        #tic-tac-toe-board .cell.O {
            color: #F87171; /* Red for O */
        }


        /* Dark Mode adjustments for specific elements */
        body.dark-mode #chat-messages {
            border-bottom-color: #444;
        }
        body.dark-mode #chat-box-container {
            background-color: rgba(40, 40, 40, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode #top-bar, body.dark-mode #bottom-controls, body.dark-mode #gift-panel-container {
            background-color: rgba(0, 0, 0, 0.8);
        }
        body.dark-mode #floating-panels-container {
            background-color: rgba(0, 0, 0, 0.8);
            color: #eee;
        }
        body.dark-mode .floating-panel-item {
            background-color: rgba(255, 255, 255, 0.05);
            color: #eee;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.05);
        }
        body.dark-mode #chat-input-area input {
            background-color: #333;
            color: #eee;
            border-color: #555;
        }
        body.dark-mode #user-info-popup {
            background-color: rgba(40, 40, 40, 0.95);
            color: #eee;
        }
        body.dark-mode #gift-categories button {
            background-color: rgba(255,255,255,0.1);
        }
        body.dark-mode #gift-categories button.active, body.dark-mode #gift-categories button:hover {
            background-color: #FF4500;
        }
        body.dark-mode .gift-item {
            background-color: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div id="room-container">
        <!-- Top Bar - User Info & Global Controls -->
        <div id="top-bar">
            <div class="user-info">
                <img id="current-user-avatar" src="https://placehold.co/45x45/cccccc/333333?text=User" alt="User Avatar"/>
                <div>
                    <span id="current-username">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
                    <div class="flex items-center gap-2 text-yellow-400">
                        <i class="fas fa-coins"></i>
                        <span id="user-coin-balance">0</span>
                    </div>
                </div>
            </div>
            <div class="global-controls">
                <button id="toggle-music-btn">üéµ ŸÖŸàÿ≥ŸäŸÇŸâ</button>
                <button id="toggle-dark-mode-btn">üåô ÿßŸÑŸàÿ∂ÿπ</button>
                <!-- Add timer here as per request -->
                <div id="stayTimer" class="floating-panel-item bg-transparent shadow-none border-none !p-0 !m-0 !text-white !font-bold">
                    ‚è≥ <span id="timer">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- Stage Mics Grid - Main central area for featured speakers -->
        <div id="stage-mics-grid">
            <!-- 10 fixed stage mic slots -->
            <div class="stage-mic-slot" data-mic-index="1">
                <span class="mic-number">1</span>
                <!-- Content for occupied mic will be added by JS -->
            </div>
            <div class="stage-mic-slot" data-mic-index="2">
                <span class="mic-number">2</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="3">
                <span class="mic-number">3</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="4">
                <span class="mic-number">4</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="5">
                <span class="mic-number">5</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="6">
                <span class="mic-number">6</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="7">
                <span class="mic-number">7</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="8">
                <span class="mic-number">8</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="9">
                <span class="mic-number">9</span>
            </div>
            <div class="stage-mic-slot" data-mic-index="10">
                <span class="mic-number">10</span>
            </div>
        </div>

        <!-- Central Announcement/Message Area -->
        <div id="central-message-area" class="popup">
            <h3 class="font-bold text-xl mb-2">üì£ ÿ•ÿπŸÑÿßŸÜ ŸáÿßŸÖ!</h3>
            <p>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉŸÖ ŸÅŸä ÿßŸÑÿ∫ÿ±ŸÅÿ©! Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿ®ŸÇŸàÿßÿπÿØ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ÿßÿØŸÑ.</p>
            <button onclick="closePopup('central-message-area')" class="button bg-gray-500 hover:bg-gray-600 mt-4">ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>

        <!-- Room Description Display -->
        <p id="room-description" class="text-center text-white text-lg my-4 p-2 bg-black bg-opacity-30 rounded-lg max-w-xl mx-auto"></p>
        
        <!-- Button to request mic (added for stage mics) -->
        <button id="request-mic-btn">
            üé§ ÿ∑ŸÑÿ® ÿµÿπŸàÿØ ÿßŸÑŸÖÿßŸäŸÉ
        </button>

        <!-- General Mics Grid - For other users in the room (smaller) -->
        <div id="general-mics-grid">
            <!-- General user mic circles will be dynamically added here by JS -->
            <!-- Example General Mic (will be replaced by dynamic content) -->
            <div class="general-mic-circle flex flex-col items-center justify-center relative" data-user-id="generalUser1">
                <img src="https://placehold.co/55x55/ff0000/ffffff?text=U2" alt="General User 1" class="w-14 h-14 rounded-full object-cover border-3 border-white shadow-md"/>
                <span class="mic-name text-white font-semibold text-shadow-sm">ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπÿßÿØŸä</span>
                <span class="user-status online"></span>
            </div>
        </div>

        <!-- Tic-Tac-Toe Game Container -->
        <div id="game-container" class="hidden w-full max-w-md mx-auto my-4 p-4 bg-gray-800/80 rounded-2xl shadow-lg border border-purple-500">
            <h3 class="text-xl font-bold text-center text-white mb-4">ŸÑÿπÿ®ÿ© XO</h3>
            <div id="game-status" class="text-center text-yellow-400 mb-4 h-6"></div>
            <div id="tic-tac-toe-board" class="grid grid-cols-3 gap-2 w-64 h-64 mx-auto">
                <!-- Cells will be generated by JS -->
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="start-game-btn" class="btn btn-success">ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©</button>
                <button id="reset-game-btn" class="btn btn-danger">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÑÿπÿ®ÿ©</button>
            </div>
        </div>

        <!-- Bottom Control Bar -->
        <div id="bottom-controls">
            <div class="control-button" id="play-game-btn-bottom">
                <i class="fas fa-gamepad"></i>
                <span>ÿßŸÑÿ£ŸÑÿπÿßÿ®</span>
            </div>
            <div class="control-button" id="toggle-mic-btn-bottom">
                <i class="fas fa-microphone"></i>
                <span>ÿßŸÑŸÖÿßŸäŸÉ</span>
            </div>
            <div class="control-button" id="send-gift-btn-bottom">
                <i class="fas fa-gift"></i>
                <span>ŸáÿØŸäÿ©</span>
            </div>
            <div class="control-button" id="toggle-chat-btn-bottom">
                <i class="fas fa-comment-dots"></i>
                <span>ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</span>
            </div>
            <div class="control-button" id="show-panels-btn-bottom">
                <i class="fas fa-ellipsis-h"></i>
                <span>ÿßŸÑŸÖÿ≤ŸäÿØ</span>
            </div>
            <div class="control-button" id="exit-room-btn-bottom">
                <i class="fas fa-sign-out-alt"></i>
                <span>ÿÆÿ±Ÿàÿ¨</span>
            </div>
        </div>
    </div>

    <!-- Chat Box - Positioned to the side/bottom-right -->
    <div id="chat-box-container">
        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">üí¨ ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿπÿßŸÖÿ©</h3>
        <div id="chat-messages">
            <div id="chat-disabled-message" class="hidden p-4 text-center text-yellow-600 bg-yellow-100 rounded-lg">
                <p class="font-bold">ŸÖŸäÿ≤ÿ© ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ŸÖÿπÿ∑ŸÑÿ© ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ©.</p>
                <p class="text-sm">ÿ¥ÿ∫ŸëŸÑ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ≠ŸÑŸäŸãÿß ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿØÿ±ÿØÿ¥ÿ©.</p>
            </div>
            <!-- Chat messages will be dynamically added here -->
            <div class="chat-message text-sm p-2 rounded-lg bg-gray-100 dark:bg-gray-700 mb-2">
                <span class="font-bold text-blue-600 dark:text-blue-400">ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä:</span> ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ÿßŸÑÿ¨ŸÖŸäÿπ!
            </div>
            <div class="chat-message text-sm p-2 rounded-lg bg-red-100 dark:bg-red-700 mb-2">
                <span class="font-bold text-red-600 dark:text-red-400">ŸÖÿ¥ÿ±ŸÅ:</span> Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿ®ÿßŸÑŸÇŸàÿßŸÜŸäŸÜ.
            </div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." />
            <button id="send-message-btn" class="button bg-blue-600 hover:bg-blue-700">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
        </div>
    </div>

    <!-- Gift Panel - Positioned to the side/bottom-right -->
    <div id="gift-panel-container">
        <h3 class="text-xl font-bold mb-4 text-white">üéÅ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸáÿØÿßŸäÿß</h3>
        <div id="gift-categories">
            <button class="active" data-category="all">ÿßŸÑŸÉŸÑ</button>
            <button data-category="romantic">ÿ±ŸàŸÖÿßŸÜÿ≥Ÿä</button>
            <button data-category="luxury">ŸÅÿßÿÆÿ±</button>
            <button data-category="funny">ŸÖÿ∂ÿ≠ŸÉ</button>
            <button data-category="animals">ÿ≠ŸäŸàÿßŸÜÿßÿ™</button>
        </div>
        <div id="gift-list">
            <!-- Gift items will be dynamically added here -->
            <div class="gift-item" data-gift-id="rose">
                <img src="https://placehold.co/60x60/FF0000/FFFFFF?text=üåπ" alt="Rose">
                <span class="name">Ÿàÿ±ÿØÿ©</span>
                <span class="price">100 ü™ô</span>
            </div>
            <div class="gift-item" data-gift-id="car">
                <img src="https://placehold.co/60x60/0000FF/FFFFFF?text=üöó" alt="Car">
                <span class="name">ÿ≥Ÿäÿßÿ±ÿ©</span>
                <span class="price">5000 ü™ô</span>
            </div>
            <div class="gift-item" data-gift-id="laugh">
                <img src="https://placehold.co/60x60/FFFF00/000000?text=üòÇ" alt="Laugh">
                <span class="name">ÿ∂ÿ≠ŸÉÿ©</span>
                <span class="price">50 ü™ô</span>
            </div>
            <div class="gift-item" data-gift-id="dog">
                <img src="https://placehold.co/60x60/8B4513/FFFFFF?text=üê∂" alt="Dog">
                <span class="name">ŸÉŸÑÿ®</span>
                <span class="price">200 ü™ô</span>
            </div>
        </div>
        <button id="send-selected-gift-btn" class="gift-send-button">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸáÿØŸäÿ©</button>
    </div>

    <!-- Floating Panels Container (holds all side panels) -->
    <div id="floating-panels-container">
        <div id="online-counter" class="floating-panel-item bg-blue-500 text-white">üë• ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ ÿßŸÑÿ¢ŸÜ: <span id="onlineCount">0</span></div>
        <div id="userDisplay" class="floating-panel-item">
            <h3 class="font-bold text-lg mb-2">üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</h3>
            <span id="userBadgeName">ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
            <div class="mt-2">
                <p><strong>ŸÜŸÇÿßÿ∑ŸÉ:</strong> <span id="xpCounter">0</span></p>
                <p><strong>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ:</strong> <span id="levelDisplay">1</span></p>
                <p><strong>ÿßŸÑŸáÿØÿßŸäÿß:</strong> <span id="giftCounter">0</span></p>
            </div>
        </div>
        <div id="topUsersPanel" class="floating-panel-item">
            <h3 class="font-bold text-lg mb-2">üèÜ ÿ£ŸÅÿ∂ŸÑ 5 ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:</h3>
            <ol id="topUsersList" class="list-decimal list-inside p-0 m-0 text-sm">
                <li>ŸÖÿ≥ÿ™ÿÆÿØŸÖ 1 - 300 XP</li>
                <li>ŸÖÿ≥ÿ™ÿÆÿØŸÖ 2 - 240 XP</li>
                <li>ŸÖÿ≥ÿ™ÿÆÿØŸÖ 3 - 180 XP</li>
                <li>ŸÖÿ≥ÿ™ÿÆÿØŸÖ 4 - 120 XP</li>
                <li>ŸÖÿ≥ÿ™ÿÆÿØŸÖ 5 - 100 XP</li>
            </ol>
        </div>
        <div id="honorBoard" class="floating-panel-item">
            <h3 class="font-bold text-lg mb-2">üèÖ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ¥ÿ±ŸÅ:</h3>
            <ul id="honorList" class="list-none p-0 m-0 text-sm">
                <li>1. -</li>
                <li>2. -</li>
                <li>3. -</li>
            </ul>
        </div>
        <div id="entryLog" class="floating-panel-item">
            <h3 class="font-bold text-lg mb-2">üìú ÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàÿßŸÑÿÆÿ±Ÿàÿ¨:</h3>
            <ul id="logList" class="list-none p-0 m-0 text-sm"></ul>
        </div>
        <div id="achievements-box" class="floating-panel-item">
            <h3 class="font-bold text-lg mb-2">üèÖ ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™:</h3>
            <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ ÿ≠ÿßŸÑŸäŸãÿß.</p>
        </div>

        <!-- New panel for "More" options / Settings / Admin Controls -->
        <div id="more-options-panel" class="floating-panel-item">
            <h3 class="font-bold text-lg mb-4">‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅÿ© (ŸÑŸÑŸÖÿ¥ÿ±ŸÅŸäŸÜ)</h3>
            <div class="flex flex-col gap-4">
                <div>
                    <label for="room-desc-input" class="block text-sm font-medium text-gray-300 mb-1">ŸàÿµŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©</label>
                    <input type="text" id="room-desc-input" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" placeholder="ÿßŸÉÿ™ÿ® ŸàÿµŸÅŸãÿß ŸÑŸÑÿ∫ÿ±ŸÅÿ©...">
                </div>
                <div>
                    <label for="room-bg-input" class="block text-sm font-medium text-gray-300 mb-1">ÿ±ÿßÿ®ÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ©</label>
                    <input type="text" id="room-bg-input" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" placeholder="https://example.com/image.jpg">
                </div>
                <button id="update-room-settings-btn" class="btn btn-primary">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
            </div>
            <h3 class="font-bold text-lg mb-4 mt-6">‚öôÔ∏è ÿÆŸäÿßÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©</h3>
            <div class="grid grid-cols-2 gap-3">
                <button id="settings-btn" class="button bg-gray-700 hover:bg-gray-800 text-sm py-2"><i class="fas fa-cog"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
                <button id="edit-profile-btn" class="button bg-blue-500 hover:bg-blue-600 text-sm py-2"><i class="fas fa-user-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ</button>
                <button id="change-background-btn" class="button bg-purple-500 hover:bg-purple-600 text-sm py-2"><i class="fas fa-image"></i> ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿÆŸÑŸÅŸäÿ©</button>
                <button id="copy-room-link-btn" class="button bg-indigo-500 hover:bg-indigo-600 text-sm py-2"><i class="fas fa-share-alt"></i> ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
                <button id="gift-log-btn" class="button bg-pink-500 hover:bg-pink-600 text-sm py-2"><i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸáÿØÿßŸäÿß</button>
                <button id="report-user-btn" class="button bg-yellow-500 hover:bg-yellow-600 text-sm py-2"><i class="fas fa-exclamation-triangle"></i> ÿ•ÿ®ŸÑÿßÿ∫</button>
                <button id="room-rules-btn" class="button bg-teal-500 hover:bg-teal-600 text-sm py-2"><i class="fas fa-gavel"></i> ŸÇŸàÿßŸÜŸäŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
                <button id="send-announcement-btn" class="button bg-orange-500 hover:bg-orange-600 text-sm py-2"><i class="fas fa-bullhorn"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±</button>
                <button id="mic-lock-btn" class="button bg-red-500 hover:bg-red-600 text-sm py-2"><i class="fas fa-lock"></i> ŸÇŸÅŸÑ ÿßŸÑŸÖÿßŸäŸÉ</button>
                <button id="mute-all-users-btn" class="button bg-orange-700 hover:bg-orange-800 text-sm py-2"><i class="fas fa-volume-mute"></i> ŸÉÿ™ŸÖ ÿßŸÑÿ¨ŸÖŸäÿπ</button>
                <button id="assign-moderator-btn" class="button bg-green-500 hover:bg-green-600 text-sm py-2"><i class="fas fa-shield-alt"></i> ÿ™ÿπŸäŸäŸÜ ŸÖÿ¥ÿ±ŸÅ</button>
                <!-- Add other admin/moderator buttons here if needed, or make them appear dynamically -->
                <button id="show-top-users-btn-panel" class="button bg-purple-700 hover:bg-purple-800 text-sm py-2"><i class="fas fa-trophy"></i> ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸàŸÜ</button>
            </div>
        </div>
    </div>

    <!-- User Info Popup (when clicking on a mic) -->
    <div id="user-info-popup" class="popup">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h3>
        <img id="popup-user-avatar" src="https://placehold.co/100x100/cccccc/333333?text=User" alt="User Avatar" class="w-24 h-24 rounded-full object-cover border-4 border-blue-500 mx-auto mb-4 shadow-md"/>
        <p class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-2"><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> <span id="popup-username"></span></p>
        <p class="text-md text-gray-600 dark:text-gray-300 mb-4"><strong>ID:</strong> <span id="popup-userid"></span> <button onclick="copyToClipboard(document.getElementById('popup-userid').textContent)" class="text-blue-500 hover:underline text-sm ml-2">ŸÜÿ≥ÿÆ</button></p>
        <p class="text-md text-gray-600 dark:text-gray-300 mb-4"><strong>ÿßŸÑŸÜÿ®ÿ∞ÿ©:</strong> <span id="popup-bio"></span></p>
        <p class="text-md text-gray-600 dark:text-gray-300 mb-4"><strong>ŸÜŸÇÿßÿ∑ ÿßŸÑÿÆÿ®ÿ±ÿ© (XP):</strong> <span id="popup-xp"></span></p>
        <p class="text-md text-gray-600 dark:text-gray-300 mb-4"><strong>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ:</strong> <span id="popup-level"></span> <span id="popup-level-badge"></span></p>
        <p class="text-md text-gray-600 dark:text-gray-300 mb-4"><strong>ÿßŸÑÿ±ÿ™ÿ®ÿ©:</strong> <span id="popup-role"></span></p>

        <div id="popup-action-buttons" class="flex flex-wrap justify-center gap-3 mt-6">
            <button onclick="sendPrivateMessagePopup(document.getElementById('popup-userid').textContent, document.getElementById('popup-username').textContent)" class="button bg-blue-600 hover:bg-blue-700"><i class="fas fa-envelope"></i> ÿ±ÿ≥ÿßŸÑÿ© ÿÆÿßÿµÿ©</button>
            <button onclick="sendGiftPopup(document.getElementById('popup-userid').textContent, document.getElementById('popup-username').textContent)" class="button bg-pink-600 hover:bg-pink-700"><i class="fas fa-gift"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ŸáÿØŸäÿ©</button>
            <button onclick="increaseReaction(document.getElementById('popup-userid').textContent)" class="button bg-red-500 hover:bg-red-600"><i class="fas fa-fire"></i> ÿ™ŸÅÿßÿπŸÑ</button>
            
            <!-- Moderation buttons - controlled by JS based on current user's role -->
            <button id="popup-mute-btn" class="button bg-yellow-500 hover:bg-yellow-600"><i class="fas fa-volume-mute"></i> ŸÉÿ™ŸÖ</button>
            <button id="popup-kick-btn" class="button bg-red-700 hover:bg-red-800"><i class="fas fa-ban"></i> ÿ∑ÿ±ÿØ</button>
            <button id="popup-ban-btn" class="button bg-red-900 hover:bg-red-950"><i class="fas fa-user-slash"></i> ÿ≠ÿ∏ÿ±</button>
            <button id="popup-report-btn" class="button bg-orange-500 hover:bg-orange-600"><i class="fas fa-exclamation-triangle"></i> ÿ™ÿ®ŸÑŸäÿ∫</button>
            
            <!-- Mic Ascent/Descent/Move buttons - controlled by JS -->
            <button id="popup-mic-up-btn" class="button bg-green-500 hover:bg-green-600"><i class="fas fa-microphone-alt"></i> ÿµÿπŸàÿØ ÿßŸÑŸÖÿßŸäŸÉ</button>
            <button id="popup-mic-down-btn" class="button bg-red-500 hover:bg-red-600"><i class="fas fa-microphone-alt-slash"></i> ŸÜÿ≤ŸàŸÑ ÿßŸÑŸÖÿßŸäŸÉ</button>
            <button id="popup-move-mic-btn" class="button bg-purple-500 hover:bg-purple-600"><i class="fas fa-exchange-alt"></i> ŸÜŸÇŸÑ ŸÑŸÉÿ±ÿ≥Ÿä ÿ¢ÿÆÿ±</button>
            <button id="popup-promote-mod-btn" class="button bg-indigo-500 hover:bg-indigo-600"><i class="fas fa-user-shield"></i> ÿ™ÿ±ŸÇŸäÿ© ŸÑŸÖÿ¥ÿ±ŸÅ</button>
            <button id="popup-prevent-mic-btn" class="button bg-red-800 hover:bg-red-900"><i class="fas fa-microphone-slash"></i> ŸÖŸÜÿπ ÿµÿπŸàÿØ</button>

            <button onclick="closePopup('user-info-popup')" class="button bg-gray-500 hover:bg-gray-600"><i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
    </div>

    <!-- Confirmation Popup for Exit -->
    <div id="exit-confirm-popup" class="popup">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü</h3>
        <div class="flex gap-4">
            <button id="confirm-exit-yes" class="button bg-red-600 hover:bg-red-700">ŸÜÿπŸÖÿå ÿßÿÆÿ±ÿ¨</button>
            <button id="confirm-exit-no" class="button bg-gray-500 hover:bg-gray-600">ŸÑÿßÿå ÿßÿ®ŸÇŸé</button>
        </div>
    </div>

    <!-- Edit Profile Popup -->
    <div id="edit-profile-popup" class="popup">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
        <div class="w-full max-w-sm flex flex-col gap-4 text-right">
            <div>
                <label for="profile-username-input" class="block text-sm font-medium text-gray-400 mb-1">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                <input type="text" id="profile-username-input" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ¨ÿØŸäÿØ...">
            </div>
            <div>
                <label for="profile-avatar-input" class="block text-sm font-medium text-gray-400 mb-1">ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ±ŸÖÿ≤Ÿäÿ©</label>
                <input type="text" id="profile-avatar-input" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" placeholder="https://example.com/avatar.png">
            </div>
            <div>
                <label for="profile-bio-input" class="block text-sm font-medium text-gray-400 mb-1">ÿßŸÑŸÜÿ®ÿ∞ÿ© ÿßŸÑÿ™ÿπÿ±ŸäŸÅŸäÿ©</label>
                <textarea id="profile-bio-input" rows="3" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" placeholder="ÿßŸÉÿ™ÿ® ŸÜÿ®ÿ∞ÿ© ÿπŸÜŸÉ..."></textarea>
            </div>
        </div>
        <div class="flex gap-4 mt-6">
            <button id="save-profile-btn" class="button bg-green-600 hover:bg-green-700">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™</button>
            <button onclick="closePopup('edit-profile-popup')" class="button bg-gray-500 hover:bg-gray-600">ÿ•ŸÑÿ∫ÿßÿ°</button>
        </div>
    </div>

    <!-- Room Rules Popup -->
    <div id="room-rules-popup" class="popup">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">üìã ŸÇŸàÿßŸÜŸäŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ©</h3>
        <div class="text-left text-gray-700 dark:text-gray-200 mb-6 max-h-64 overflow-y-auto">
            <p class="mb-2">1. ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ÿßÿØŸÑ ÿ®ŸäŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.</p>
            <p class="mb-2">2. ŸÖŸÖŸÜŸàÿπ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ŸÑŸÅÿßÿ∏ ÿßŸÑÿ®ÿ∞Ÿäÿ¶ÿ© ÿ£Ÿà ÿßŸÑŸÖÿ≥Ÿäÿ¶ÿ©.</p>
            <p class="mb-2">3. ŸÖŸÖŸÜŸàÿπ ŸÜÿ¥ÿ± ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ© ÿ£Ÿà ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿ®ÿØŸàŸÜ ÿ•ÿ∞ŸÜ ÿßŸÑŸÖÿ¥ÿ±ŸÅ.</p>
            <p class="mb-2">4. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿ®ŸÖŸàÿ∂Ÿàÿπ ÿßŸÑÿ∫ÿ±ŸÅÿ© (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ≠ÿØÿØŸãÿß).</p>
            <p class="mb-2">5. ÿßŸÑŸÖÿ¥ÿ±ŸÅŸàŸÜ ŸÑÿØŸäŸáŸÖ ÿßŸÑÿ≠ŸÇ ŸÅŸä ÿßÿ™ÿÆÿßÿ∞ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÑÿßÿ≤ŸÖÿ© ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÖ.</p>
            <p class="mb-2">6. ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ŸàŸÇÿ™ŸÉ Ÿàÿ™ŸÅÿßÿπŸÑ ÿ®ÿ•Ÿäÿ¨ÿßÿ®Ÿäÿ©!</p>
        </div>
        <button onclick="closePopup('room-rules-popup')" class="button bg-blue-600 hover:bg-blue-700">ÿ≠ÿ≥ŸÜÿßŸã</button>
    </div>

    <!-- Global Popups/Toasts (managed by utils.js) -->
    <div id="welcome-popup" class="popup">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">üëã ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä AirChat!</h3>
        <p class="text-gray-700 dark:text-gray-200 mb-6">ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑÿØÿ±ÿØÿ¥ÿ© üí¨</p>
        <button onclick="closeWelcomePopup()" class="button bg-blue-600 hover:bg-blue-700">ÿ≠ÿ≥ŸÜÿßŸã</button>
    </div>
    <div id="toast" class="toast-notification"></div>
    <div id="gift-animation" class="gift-animation">üéÅ</div>

    <!-- Audio Elements -->
    <audio id="bg-music" loop></audio>
    <audio id="mic-audio" muted></audio>
    <audio id="welcomeAudio" src="./assets/sounds/welcome.mp3"></audio>
    <audio id="newMessageSound" src="./assets/sounds/new-message.mp3"></audio>
    <audio id="giftSound" src="./assets/sounds/gift-sound.mp3"></audio>
    <audio id="userLeaveSound" src="./assets/sounds/user-leave.mp3"></audio>

    <!-- JavaScript Modules -->
    <script type="module" src="./main.js"></script>
    <script type="module" src="./room_ui.js"></script>
    <script type="module" src="./room_logic.js"></script>
    <script type="module" src="./webrtc.js"></script>

    <script>
        // Show notification if running on a static host like GitHub Pages
        if (window.location.host.includes('github.io')) {
            const chatDisabledMessage = document.getElementById('chat-disabled-message');
            if (chatDisabledMessage) {
                chatDisabledMessage.classList.remove('hidden');
            }
        }
    </script>

    <script type="module">
        // Import functions from other modules to make them accessible globally if needed,
        // or ensure they are called via event listeners or module exports.
        import {
            sendMessage, sendGift, toggleMusic, toggleMicLock, makeAnnouncement,
            muteAllUsers, pinMessage, copyRoomLink, exitRoom, simulateXPAction,
            toggleDarkMode, assignModerator, reportUser, changeUsername,
            requestMicAscent, requestMicDescent, // Mic stage control
            kickUser, banUser, toggleUserMute, // Moderation actions
            transferUserMic, preventMicAscent, updateRoomSettings, saveProfile // New moderation actions
        } from './room_logic.js';

        // Expose functions to global scope for inline onclick/onchange attributes
        window.sendMessage = sendMessage;
        window.sendGift = sendGift;
        window.toggleMusic = toggleMusic;
        window.toggleMicLock = toggleMicLock;
        window.makeAnnouncement = makeAnnouncement;
        window.muteAllUsers = muteAllUsers;
        window.pinMessage = pinMessage;
        window.copyRoomLink = copyRoomLink;
        window.exitRoom = exitRoom;
        window.simulateXPAction = simulateXPAction;
        window.toggleDarkMode = toggleDarkMode;
        window.assignModerator = assignModerator;
        window.reportUser = reportUser;
        window.changeUsername = changeUsername;
        window.requestMicAscent = requestMicAscent;
        window.requestMicDescent = requestMicDescent;
        window.kickUser = kickUser;
        window.banUser = banUser;
        window.toggleUserMute = toggleUserMute;
        window.transferUserMic = transferUserMic;
        window.preventMicAscent = preventMicAscent;
        window.updateRoomSettings = updateRoomSettings; // Expose for the button


        // Import UI functions that need to be called by inline events or directly
        import {
            showUserInfoPopup, closePopup, showWelcomePopup, closeWelcomePopup,
            updateXPDisplay, updateLevelDisplay, updateGiftCounterDisplay, updateUserBadgeNameDisplay,
            toggleChatBox, toggleFloatingPanels, toggleGiftPanel,
            populateStageMics, populateGeneralMics,
            updateUserInfoPopup, showCustomAlert, updateOnlineCount, updateStayTimer,
            showRoomRulesPopup, showExitConfirmPopup, showEditProfilePopup, updateUserDisplay // New popups
        } from './room_ui.js';

        window.showUserInfoPopup = showUserInfoPopup;
        window.closePopup = closePopup;
        window.showWelcomePopup = showWelcomePopup;
        window.closeWelcomePopup = closeWelcomePopup;
        window.updateXPDisplay = updateXPDisplay;
        window.updateLevelDisplay = updateLevelDisplay;
        window.updateGiftCounterDisplay = updateGiftCounterDisplay;
        window.updateUserBadgeNameDisplay = updateUserBadgeNameDisplay;
        window.toggleChatBox = toggleChatBox;
        window.toggleFloatingPanels = toggleFloatingPanels;
        window.toggleGiftPanel = toggleGiftPanel; // Expose new gift panel toggle
        window.populateStageMics = populateStageMics;
        window.populateGeneralMics = populateGeneralMics;
        window.updateUserInfoPopup = updateUserInfoPopup;
        window.showCustomAlert = showCustomAlert;
        window.updateOnlineCount = updateOnlineCount;
        window.updateStayTimer = updateStayTimer;
        window.showRoomRulesPopup = showRoomRulesPopup;
        window.showExitConfirmPopup = showExitConfirmPopup;

        // For mic-specific actions from popup (e.g., mute, kick, ban)
        import { sendPrivateMessagePopup, sendGiftPopup, increaseReaction } from './room_ui.js';
        window.sendPrivateMessagePopup = sendPrivateMessagePopup;
        window.sendGiftPopup = sendGiftPopup;
        window.increaseReaction = increaseReaction;

        // Import WebRTC specific functions
        import { toggleLocalMic } from './webrtc.js';
        document.getElementById('toggle-mic-btn-bottom').addEventListener('click', toggleLocalMic);
        document.getElementById('request-mic-btn').addEventListener('click', requestMicAscent); // Request mic ascent from the main button

        // Event listeners for bottom controls
        document.getElementById('toggle-chat-btn-bottom').addEventListener('click', toggleChatBox);
        document.getElementById('show-panels-btn-bottom').addEventListener('click', toggleFloatingPanels);
        document.getElementById('exit-room-btn-bottom').addEventListener('click', showExitConfirmPopup); // Show confirmation popup
        document.getElementById('send-gift-btn-bottom').addEventListener('click', toggleGiftPanel); // Show gift panel

        // Event listener for "ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸàŸÜ" button inside "More Options" panel
        document.getElementById('show-top-users-btn-panel').addEventListener('click', () => {
            window.location.href = 'top_users.html'; // Navigate to top users page
        });

        // Event listener for the new room settings update button
        document.getElementById('update-room-settings-btn').addEventListener('click', () => {
            const newDesc = document.getElementById('room-desc-input').value;
            const newBg = document.getElementById('room-bg-input').value;
            updateRoomSettings(newDesc, newBg);
            // Also close the floating panel after clicking
            document.getElementById('floating-panels-container').classList.remove('show');
        });

        // Event listeners for "More Options" panel buttons
        document.getElementById('settings-btn').addEventListener('click', () => showCustomAlert('ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ (ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)', 'info'));

        // New event listener for the "Edit Profile" button
        document.getElementById('edit-profile-btn').addEventListener('click', () => {
            showEditProfilePopup();
        });

        // New event listener for the "Save Profile" button in the popup
        document.getElementById('save-profile-btn').addEventListener('click', () => {
            const newUsername = document.getElementById('profile-username-input').value;
            const newAvatar = document.getElementById('profile-avatar-input').value;
            const newBio = document.getElementById('profile-bio-input').value;

            saveProfile({
                username: newUsername,
                avatar: newAvatar,
                bio: newBio
            });

            closePopup('edit-profile-popup');
        });

        document.getElementById('change-background-btn').addEventListener('click', () => showCustomAlert('ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿÆŸÑŸÅŸäÿ© (ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)', 'info'));
        document.getElementById('copy-room-link-btn').addEventListener('click', () => {
            // This will copy the current room URL
            const roomLink = window.location.href;
            navigator.clipboard.writeText(roomLink).then(() => {
                showCustomAlert('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
            }).catch(err => {
                showCustomAlert('ŸÅÿ¥ŸÑ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ∫ÿ±ŸÅÿ©.', 'error');
                console.error('Failed to copy room link: ', err);
            });
        });
        document.getElementById('gift-log-btn').addEventListener('click', () => showCustomAlert('ÿ≥ÿ¨ŸÑ ÿßŸÑŸáÿØÿßŸäÿß (ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)', 'info'));
        document.getElementById('report-user-btn').addEventListener('click', () => showCustomAlert('ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)', 'info'));
        document.getElementById('room-rules-btn').addEventListener('click', showRoomRulesPopup); // Show room rules popup
        document.getElementById('send-announcement-btn').addEventListener('click', () => showCustomAlert('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)', 'info'));
        document.getElementById('mic-lock-btn').addEventListener('click', toggleMicLock); // Assuming this will be a global mic lock
        document.getElementById('mute-all-users-btn').addEventListener('click', muteAllUsers); // Assuming this will mute all general users
        document.getElementById('assign-moderator-btn').addEventListener('click', () => showCustomAlert('ÿ™ÿπŸäŸäŸÜ ŸÖÿ¥ÿ±ŸÅ (ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)', 'info')); // This will need a user selection mechanism

        // Event listeners for Exit Confirmation Popup
        document.getElementById('confirm-exit-yes').addEventListener('click', exitRoom);
        document.getElementById('confirm-exit-no').addEventListener('click', () => closePopup('exit-confirm-popup'));

        // Initial setup for the page after all scripts are loaded
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('id');
            if (!roomId) {
                console.warn('No room ID specified in URL. Joining default room.');
            }

            // Example usage for populating mics and user info (replace with actual data from server)
            const dummyStageUsers = [
                { id: 'user123', username: 'ŸÖÿ≠ŸÖÿØ', avatar: 'https://placehold.co/80x80/007bff/ffffff?text=Mohamed', isSpeaking: true, isMuted: false, role: 'member', isOnline: true, micIndex: 1 },
                { id: 'user456', username: 'ŸÅÿßÿ∑ŸÖÿ©', avatar: 'https://placehold.co/80x80/ff00ff/ffffff?text=Fatima', isSpeaking: false, isMuted: false, role: 'moderator', isOnline: true, micIndex: 3 },
                { id: 'user789', username: 'ÿπŸÑŸä', avatar: 'https://placehold.co/80x80/00ff00/ffffff?text=Ali', isSpeaking: false, isMuted: true, role: 'member', isOnline: true, micIndex: 5 }
            ];
            populateStageMics(dummyStageUsers);

            const dummyGeneralUsers = [
                { id: 'genUser1', username: 'ÿ≥ÿßÿ±ÿ©', avatar: 'https://placehold.co/50x50/ffa500/ffffff?text=Sara', isSpeaking: false, isMuted: false, role: 'member', isOnline: true },
                { id: 'genUser2', username: 'ÿÆÿßŸÑÿØ', avatar: 'https://placehold.co/50x50/800080/ffffff?text=Khaled', isSpeaking: true, isMuted: false, role: 'member', isOnline: true },
                { id: 'genUser3', username: 'ŸÑŸäŸÑŸâ', avatar: 'https://placehold.co/50x50/008080/ffffff?text=Layla', isSpeaking: false, isMuted: false, role: 'vip', isOnline: true },
                { id: 'genUser4', username: 'ÿ£ÿ≠ŸÖÿØ', avatar: 'https://placehold.co/50x50/c0c0c0/000000?text=Ahmed', isSpeaking: false, isMuted: false, role: 'member', isOnline: true },
                { id: 'genUser5', username: 'ŸÜŸàÿ±', avatar: 'https://placehold.co/50x50/ffc0cb/000000?text=Noor', isSpeaking: false, isMuted: false, role: 'member', isOnline: true },
                { id: 'genUser6', username: 'ŸäŸàÿ≥ŸÅ', avatar: 'https://placehold.co/50x50/8a2be2/ffffff?text=Yousef', isSpeaking: false, isMuted: false, role: 'member', isOnline: true },
                { id: 'genUser7', username: 'ŸÖÿ±ŸäŸÖ', avatar: 'https://placehold.co/50x50/00ced1/ffffff?text=Maryam', isSpeaking: false, isMuted: false, role: 'member', isOnline: true },
            ];
            populateGeneralMics(dummyGeneralUsers);

            // Update current user info (example)
            updateCurrentUserDisplay({
                id: 'currentUser777',
                username: 'ŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©',
                avatar: 'https://placehold.co/45x45/FFD700/000000?text=Admin',
                role: 'admin' // Set current user role for testing moderation buttons
            });

            // Initial updates for general panels
            updateOnlineCount(dummyStageUsers.length + dummyGeneralUsers.length);
            updateXPDisplay(500);
            updateLevelDisplay(5);
            updateGiftCounterDisplay(10);
            updateUserBadgeNameDisplay('ŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©');

            // Start timer (example)
            let seconds = 0;
            setInterval(() => {
                seconds++;
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                updateStayTimer(
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`
                );
            }, 1000);

        });
    </script>
</body>
</html>
