<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - AirChat</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to your global styles -->
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* Specific styles for the settings container, complementing style.css */
        .settings-container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 500px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .settings-container h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 1.5rem;
        }
        .setting {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Align labels to the right for Arabic */
            gap: 0.5rem;
            width: 100%;
        }
        .setting label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        .setting input, .setting select {
            width: 100%;
        }
        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .actions .button {
            flex-grow: 1; /* Make buttons expand to fill space */
        }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen bg-gray-100 dark:bg-gray-900">
    <div class="settings-container">
        <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

        <div class="setting">
            <label for="username-input">Ø§Ù„Ø§Ø³Ù…:</label>
            <input type="text" id="username-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
        </div>

        <div class="setting">
            <label for="bg-select">Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
            <select id="bg-select">
                <option value="default">Ø§ÙØªØ±Ø§Ø¶ÙŠ</option>
                <option value="light">ÙØ§ØªØ­Ø©</option>
                <option value="dark">Ø¯Ø§ÙƒÙ†Ø©</option>
                <option value="gradient">ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ</option>
                <!-- Add more options for specific image backgrounds if available -->
            </select>
        </div>

        <div class="setting">
            <label for="lang-select">Ø§Ù„Ù„ØºØ©:</label>
            <select id="lang-select">
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="en">English</option>
            </select>
        </div>

        <div class="actions">
            <button onclick="saveSettings()" class="button bg-green-600 hover:bg-green-700">ğŸ’¾ Ø­ÙØ¸</button>
            <button onclick="goBack()" class="button bg-gray-500 hover:bg-gray-600">â†©ï¸ Ø±Ø¬ÙˆØ¹</button>
        </div>
    </div>

    <script type="module">
        import { showCustomAlert } from '/js/utils.js'; // Import custom alert utility

        // Function to save settings to localStorage and apply changes
        function saveSettings() {
            const username = document.getElementById("username-input").value;
            const background = document.getElementById("bg-select").value;
            const language = document.getElementById("lang-select").value;
            const userId = localStorage.getItem('userId'); // Get current user ID

            // Save to localStorage
            localStorage.setItem("username", username);
            localStorage.setItem("background", background);
            localStorage.setItem("language", language);

            // Apply background change immediately
            applyBackground(background);

            // Apply dark mode if selected (or remove if not)
            if (background === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Update user profile on backend (optional, but good practice)
            if (userId) {
                fetch(`/api/users/${userId}/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ username, settings: { background, language } })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showCustomAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } else {
                        showCustomAlert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving settings to backend:', error);
                    showCustomAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'error');
                });
            } else {
                showCustomAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§!', 'success');
            }
        }

        // Function to apply background based on setting
        function applyBackground(setting) {
            document.body.style.backgroundImage = 'none'; // Reset any previous image backgrounds
            document.body.style.backgroundSize = 'auto';
            document.body.style.backgroundPosition = 'initial';

            switch (setting) {
                case 'light':
                    document.body.style.backgroundColor = '#f0f8ff'; // Light blue
                    document.body.classList.remove('dark-mode');
                    break;
                case 'dark':
                    document.body.style.backgroundColor = '#1a1a1a'; // Dark gray
                    document.body.classList.add('dark-mode');
                    break;
                case 'gradient':
                    document.body.style.background = 'linear-gradient(-45deg, #e3ffe7, #d9e7ff, #fceabb, #f8b500)';
                    document.body.style.backgroundSize = '400% 400%';
                    document.body.style.animation = 'gradientBG 15s ease infinite';
                    document.body.classList.remove('dark-mode'); // Assuming gradients are light mode
                    break;
                case 'default':
                default:
                    document.body.style.backgroundColor = '#f0f2f5'; // Default light gray
                    document.body.classList.remove('dark-mode');
                    break;
            }
        }

        // Keyframe for gradient background animation (if used)
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes gradientBG {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }
        `;
        document.head.appendChild(styleSheet);


        // Function to go back to the previous page
        function goBack() {
            window.history.back();
        }

        // Load previous settings when the page loads
        window.onload = () => {
            document.getElementById("username-input").value = localStorage.getItem("username") || "";
            document.getElementById("bg-select").value = localStorage.getItem("background") || "default";
            document.getElementById("lang-select").value = localStorage.getItem("language") || "ar";

            // Apply initial background setting
            applyBackground(localStorage.getItem("background") || "default");
        };
    </script>
</body>
</html>
